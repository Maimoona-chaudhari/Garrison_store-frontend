<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - Garrison Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .product-image {
      max-height: 400px;
      object-fit: contain;
    }
    .review-card {
      border-left: 3px solid #125d28de;
      margin-bottom: 15px;
    }
    .star-rating {
      color: gold;
      font-size: 1.2rem;
    }
    .navbar-brand {
      font-family: 'Georgia', serif;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1100;
    }
  </style>
</head>
<body>
  <!-- Toast Notifications -->
  <div class="toast-container"></div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg" style="background-color: #125d28de;">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="index.html">üåø Garrison Store</a>
        <a href="index.html" class="btn text-white">
        Home 
      </a>
      <a href="cart.html" class="btn text-white">
        üõí Cart <span id="cart-count" class="badge bg-danger">0</span>
      </a>
    </div>
  </nav>

  <div class="container my-5">
    <!-- Product Details -->
    <div class="row" id="product-container"></div>

    <!-- Reviews Section -->
    <div class="row mt-5">
      <div class="col-md-8 mx-auto">
        <h3>Customer Reviews</h3>
        <div id="reviews-container">
          <!-- Reviews will load here -->
        </div>
        
        <!-- ...keep the head, navbar, product HTML same... -->

<div class="review-form mt-4">
  <div id="review-form-container" style="display:none;">
    <h4>Write a Review</h4>
    <form id="reviewForm">
      <input type="hidden" id="product-id">
      <div class="mb-3">
        <select id="rating" class="form-select" required>
          <option value="" disabled selected>Select Rating</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
          <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
          <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
          <option value="2">‚≠ê‚≠ê (2)</option>
          <option value="1">‚≠ê (1)</option>
        </select>
      </div>
      <div class="mb-3">
        <textarea id="comment" class="form-control" rows="3" placeholder="Your Review" required></textarea>
      </div>
      <button type="submit" class="btn" style="background-color: #125d28de; color: white;">
        Submit Review
      </button>
    </form>
  </div>
</div>

  <script>
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');

  function getToken() {
    return localStorage.getItem('authToken');
  }

  // Show form only if logged in
  document.addEventListener('DOMContentLoaded', () => {
    const token = getToken();
    if (token) {
      document.getElementById('review-form-container').style.display = 'block';
    } else {
      document.getElementById('review-form-container').style.display = 'none';
      console.log('Login to write a review');
    }

    loadProduct();
    loadReviews();
    updateCartCount();
  });

  async function loadProduct() {
    try {
      if (!productId) throw new Error('Product ID missing');
      const response = await fetch(`https://garrisonstore-production.up.railway.app/api/products/${productId}`);
      if (!response.ok) throw new Error('Product not found');
      const product = await response.json();
      document.getElementById('product-container').innerHTML = `
        <div class="col-md-6">
          <img src="${product.image}" class="img-fluid product-image rounded" alt="${product.name}">
        </div>
        <div class="col-md-6">
          <h1>${product.name}</h1>
          <p class="text-muted">${product.description}</p>
          <h4 class="my-3">Rs ${product.price}</h4>
          <button class="btn btn-success" onclick="addToCart('${product._id}')">Add to Cart</button>
        </div>
      `;
      document.getElementById('product-id').value = product._id;
    } catch (error) {
      document.getElementById('product-container').innerHTML = `
        <div class="alert alert-danger">
          ${error.message}. <a href="catalog.html">Back to catalog</a>
        </div>
      `;
    }
  }

  async function loadReviews() {
  try {
    const response = await fetch(`https://garrisonstore-production.up.railway.app/api/reviews/${productId}`);
    if (!response.ok) throw new Error('Failed to load reviews');
    const reviews = await response.json();

    const container = document.getElementById('reviews-container');
    if (reviews.length === 0) {
      container.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review!</p>';
      return;
    }

    container.innerHTML = reviews.map(r => `
      <div class="card review-card">
        <div class="card-body">
          <h5>${r.userId?.name || 'Anonymous'}</h5>
          <div class="star-rating">${'‚≠ê'.repeat(r.rating || 1)}</div>
          <p class="card-text mt-2">${r.reviewText || ''}</p>
          <small class="text-muted">Posted on ${new Date(r.createdAt|| r.date).toLocaleDateString()}</small>
        </div>
      </div>
    `).join('');
  } catch (error) {
    console.error(error);
    document.getElementById('reviews-container').innerHTML = '<p class="text-muted">Failed to load reviews</p>';
  }
}

  
   // REVIEW FORM SUBMISSION
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const rating = parseInt(document.getElementById('rating').value); // ensure number
  const reviewText = document.getElementById('comment').value;

  const token = getToken();
  if (!token) {
    alert("Please login to submit a review.");
    return;
  }

  try {
    const res = await fetch("https://garrisonstore-production.up.railway.app/api/reviews", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ productId, rating, reviewText })
    });

    const data = await res.json();
    if (!res.ok) {
      alert("Error: " + (data.message || "Failed to submit review"));
      console.error("Submit failed:", data);
      return;
    }

    alert("‚úÖ Review submitted successfully!");
    document.getElementById("reviewForm").reset();
    loadReviews();
  } catch (err) {
    console.error("Error submitting review:", err);
    alert("Server error while submitting review.");
  }
});

  // CART FUNCTIONS
  function addToCart(productId) {
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    const product = {
      _id: productId,
      name: document.querySelector('#product-container h1').textContent,
      price: parseFloat(document.querySelector('#product-container h4').textContent.replace('$', '')),
      image: document.querySelector('#product-container img').src
    };
    cart.push(product);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    alert('Added to cart!');
  }

  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    document.getElementById('cart-count').textContent = cart.length;
  }
</script>

</body>
</html>