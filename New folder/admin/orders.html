<!DOCTYPE html>
<html>
<head>
  <title>Admin - View Orders</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .status-pending { background-color: #fff8dc; color: #b8860b; font-weight: bold; }
    .status-shipped { background-color: #e6f7ff; color: #0077b6; font-weight: bold; }
    .status-completed { background-color: #d4edda; color: #155724; font-weight: bold; }
    .search-bar { max-width: 300px; margin-bottom: 20px; }
  </style>
</head>
<body class="container my-4">

  <h1 class="mb-4">Order Management</h1>

  <!-- Search bar -->
  <input type="text" id="searchInput" class="form-control search-bar" placeholder="Search by customer or product...">

  <h2 class="mt-4">Pending / Shipped Orders</h2>
  <table id="ordersTable" class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Items</th>
        <th>Total</th>
        <th>Status</th>
        <th>Update</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 class="mt-5">Completed Orders</h2>
  <table id="completedOrdersTable" class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Items</th>
        <th>Total</th>
        <th>Status</th>
        <th>Update</th>
        <th>Download</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- jsPDF Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  async function downloadOrderPDF(orderId) {
    const res = await fetch(`https://garrisonstore-production.up.railway.app/api/orders/${orderId}`);
    const order = await res.json();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text(`Order ID: ${order._id}`, 10, 10);
    doc.text(`Customer: ${order.customerName}`, 10, 20);
    doc.text(`Email: ${order.email}`, 10, 30);
    doc.text(`Phone: ${order.phone}`, 10, 40);
    doc.text(`Address: ${order.address}`, 10, 50);
    doc.text(`Payment: ${order.paymentMethod}`, 10, 60);
    doc.text(`Total Amount: ${order.totalAmount} PKR`, 10, 70);

    if(order.advancePayment) {
      doc.text(`Advance Payment: ${order.advancePayment} PKR`, 10, 80);
    }

    doc.text(`Items:`, 10, 90);
    order.items.forEach((item, i) => {
      doc.text(`- ${item.name} (${item.price} PKR)`, 10, 100 + i * 10);
    });

    doc.save(`order_${order._id}.pdf`);
  }

  async function fetchOrders() {
    const res = await fetch(`https://garrisonstore-production.up.railway.app/api/orders`);
    const orders = await res.json();

    const pendingTableBody = document.querySelector('#ordersTable tbody');
    const completedTableBody = document.querySelector('#completedOrdersTable tbody');

    pendingTableBody.innerHTML = '';
    completedTableBody.innerHTML = '';

    orders.forEach(order => {
      const tr = document.createElement('tr');

      let statusClass = '';
      if (order.status === 'Pending') {
        statusClass = 'status-pending';
      } else if (order.status === 'Shipped') {
        statusClass = 'status-shipped';
      } else if (order.status === 'Completed') {
        statusClass = 'status-completed';
      }

      tr.innerHTML = `
        <td>${order._id}</td>
        <td class="customer-name">${order.customerName || 'Guest'}</td>
        <td class="product-names">${order.items.map(item => item.name).join(', ')}</td>
        <td>${order.totalAmount.toFixed(2)} PKR</td>
        <td>
          <select class="form-select form-select-sm ${statusClass}" id="status-${order._id}">
            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending ‚è≥</option>
            <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped üì¶</option>
            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed ‚úÖ</option>
          </select>
        </td>
        <td>
          <button class="btn btn-success btn-sm" onclick="updateStatus('${order._id}')">
            <i class="bi bi-save"></i> Save
          </button>
        </td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="downloadOrderPDF('${order._id}')">
            <i class="bi bi-download"></i> PDF
          </button>
        </td>
      `;

      if (order.status === 'Completed') {
        completedTableBody.appendChild(tr);
      } else {
        pendingTableBody.appendChild(tr);
      }
    });
  }

  async function updateStatus(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;

    const res = await fetch(`https://garrisonstore-production.up.railway.app/api/orders/${orderId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });

    if (res.ok) {
      alert('Order status updated!');
      fetchOrders();
    } else {
      alert('Failed to update order.');
    }
  }

  // Local search filter (customer + product names)
  document.getElementById('searchInput').addEventListener('input', function () {
    const searchValue = this.value.toLowerCase();
    const allRows = document.querySelectorAll('#ordersTable tbody tr, #completedOrdersTable tbody tr');

    allRows.forEach(row => {
      const customerName = row.querySelector('.customer-name')?.textContent.toLowerCase() || '';
      const productNames = row.querySelector('.product-names')?.textContent.toLowerCase() || '';

      if (customerName.includes(searchValue) || productNames.includes(searchValue)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Initial load
  fetchOrders();
  </script>

</body>
</html>
