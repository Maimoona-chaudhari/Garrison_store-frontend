<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Manage Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .admin-container {
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .product-img {
      width: 80px;
      height: auto;
      object-fit: cover;
    }
  </style>
</head>
<body>

<div class="admin-container">
  <h2 class="text-center mb-4">üåø Admin - Manage Products</h2>

  <!-- Add Product Form -->
  <h4>Add New Product</h4>
  <form id="addProductForm" enctype="multipart/form-data" class="mb-4">
    <div class="mb-2">
      <input type="text" name="name" class="form-control" placeholder="Product Name" required>
    </div>
    <div class="mb-2">
      <input type="number" name="price" class="form-control" placeholder="Price" required>
    </div>
    <div class="mb-2">
      <textarea name="description" class="form-control" placeholder="Description"></textarea>
    </div>
    <div class="mb-2">
      <select name="category" class="form-control" required>
        <option value="">-- Select Category --</option>
        <option value="Catalog">Catalog</option>
        <option value="Greens">Greens</option>
        <option value="Featured">Featured</option>
        <option value="BestSeller">Best Seller</option>
        <option value="Blooms">Blooms</option>

      </select>
    </div>
    <div class="mb-2">
      <input type="file" name="image" class="form-control" accept="image/*" required>
    </div>
    <button type="submit" class="btn btn-primary w-100">Add Product</button>
  </form>

  <hr>

  <!-- Products List -->
  <h4 class="mb-3">All Products</h4>
  <table class="table table-striped" id="productsTable">
    <thead>
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>Description</th>
        <th>Price ($)</th>
        <th>Category</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="text-center mt-4">
    <a href="dashboard.html" class="btn btn-secondary">‚¨ÖÔ∏è Back to Dashboard</a>
  </div>
</div>

<script>
const apiUrl = 'https://garrisonstore-production.up.railway.app/api/products';

// ‚úÖ Admin gate
if (localStorage.getItem('userRole') !== 'admin') {
  alert('Unauthorized! Only admin can access.');
  window.location.href = '../login.html';
}

// ‚úÖ Helper: Authorization header
const token = localStorage.getItem('authToken');
const authHeader = () => token ? { 'Authorization': 'Bearer ' + token } : {};

// ‚úÖ Load Products
async function loadProducts() {
  try {
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error('Failed to load products');
    const products = await res.json();

    const tbody = document.querySelector('#productsTable tbody');
    tbody.innerHTML = '';

    products.forEach(p => {
      const tr = document.createElement('tr');
      const imgSrc = p.image || '';
      const altText = p.name ? `Image of ${p.name}` : 'Product image';
      tr.innerHTML = `
        <td>${imgSrc ? `<img src="${imgSrc}" class="product-img" alt="${altText}">` : '‚Äî'}</td>
        <td><input class="form-control form-control-sm" value="${p.name || ''}" data-id="${p._id}" data-field="name"></td>
        <td><input class="form-control form-control-sm" value="${p.description || ''}" data-id="${p._id}" data-field="description"></td>
        <td><input type="number" class="form-control form-control-sm" value="${p.price ?? ''}" data-id="${p._id}" data-field="price"></td>
        <td><input class="form-control form-control-sm" value="${p.category || ''}" data-id="${p._id}" data-field="category"></td>
        <td>
          <button class="btn btn-success btn-sm" onclick="updateProduct('${p._id}')">Update</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p._id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
    alert('‚ùå Error loading products.');
  }
}

// ‚úÖ Add Product
document.getElementById("addProductForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  
  const formData = new FormData(this);

  try {
    const res = await fetch(apiUrl, {
      method: "POST",
      headers: { ...authHeader() }, // token if exists
      body: formData
    });

    const data = await res.json();
    if (!res.ok) {
      console.error('Create error:', data);
      alert('‚ùå Error adding product.');
      return;
    }

    alert('‚úÖ ' + data.message || 'Product added!');
    this.reset();
    loadProducts();
  } catch (err) {
    console.error(err);
    alert('‚ùå Something went wrong while adding the product.');
  }
});

// ‚úÖ Update Product
async function updateProduct(id) {
  try {
    const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
    const updated = {};
    inputs.forEach(input => {
      const field = input.getAttribute('data-field');
      let value = input.value;
      if (field === 'price') value = parseFloat(value);
      updated[field] = value;
    });

    const res = await fetch(`${apiUrl}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', ...authHeader() },
      body: JSON.stringify(updated)
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      console.error('Update error:', errData);
      alert('‚ùå Error updating product.');
      return;
    }

    alert('‚úÖ Product updated!');
    loadProducts();
  } catch (err) {
    console.error(err);
    alert('‚ùå Something went wrong while updating the product.');
  }
}

// ‚úÖ Delete Product
async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const res = await fetch(`${apiUrl}/${id}`, {
      method: 'DELETE',
      headers: { ...authHeader() }
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      console.error('Delete error:', errData);
      alert('‚ùå Error deleting product.');
      return;
    }

    alert('üóëÔ∏è Product deleted!');
    loadProducts();
  } catch (err) {
    console.error(err);
    alert('‚ùå Something went wrong while deleting the product.');
  }
}

// Initial load
loadProducts();
</script>

</body>
</html>
