<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .checkout-container {
      max-width: 900px; margin: 40px auto; background: #fff; padding: 24px;
      border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    }
    .payment-instructions { margin-top: 8px; font-weight: 600; color: #495057; }
    .billing-section { display: none; }
    .order-summary-card { border: 2px solid #0d6efd; background: #f0f8ff; border-radius: 10px; padding: 16px; }
    .order-summary-card .row > div { display: flex; justify-content: space-between; }
    .d-none-important { display: none !important; }
    .small-muted { font-size: .9rem; color:#6c757d; }
    .brand-name {
      font-family: 'Georgia', 'Brush Script MT', cursive;
      font-size: 2rem;
      color: #742a74;
    }
    .brand-icon {
      width: 24px;
      height: 28px;
      margin-right: 8px;
      border: none;
    }
    .navbar-nav-left {
      flex-direction: column;
    }
    .dropdown-menu-right {
      left: auto;
      right: 0;
    }

  </style>
</head>
<body>
  <!-- NAVBAR -->
<nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm fixed-top">
  <div class="container-fluid">

    <!-- Brand (mobile) -->
    <a class="navbar-brand d-lg-none" href="index.html">ðŸŒ¿ Garrison</a>

    <!-- Toggler -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainMenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar content -->
    <div class="collapse navbar-collapse" id="mainMenu">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="catalog.html">Our Catalog</a></li>
        <li class="nav-item"><a class="nav-link" href="greens.html">Greens</a></li>
        <li class="nav-item"><a class="nav-link" href="blooms.html">Blooms</a></li>
        <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
      </ul>

      <!-- Right icons -->
      <div class="d-flex align-items-center">
        <a href="login.html" class="btn btn-outline-success me-2"><i class="bi bi-person"></i></a>
        <a href="cart.html" class="btn btn-outline-primary position-relative">
          <i class="bi bi-cart"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count">0</span>
        </a>
      </div>
    </div>

    <!-- Brand (desktop center) -->
    <div class="d-none d-lg-block text-center position-absolute start-50 translate-middle-x" style="font-size: 1.2rem; color:#125d28;">
      ðŸŒ¿ Garrison Store
    </div>

  </div>
</nav>

  
  <div class="container checkout-container">
    <h2 class="mb-4">Checkout</h2>

    <!-- Inline status area (no browser alerts) -->
    <div id="statusArea" class="d-none"></div>

    <form id="checkoutForm" novalidate>
      <!-- Shipping -->
      <h5 class="mt-2">Shipping Address</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="customerName" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="customerName" required>
        </div>
        <div class="col-md-6">
          <label for="email" class="form-label">Email Address</label>
          <input type="email" class="form-control" id="email" required>
        </div>
        <div class="col-md-6">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="phone" required>
        </div>
        <div class="col-md-6">
          <label for="postalCode" class="form-label">Postal Code (optional)</label>
          <input type="text" class="form-control" id="postalCode">
        </div>
        <div class="col-12">
          <label for="address" class="form-label">Delivery Address</label>
          <textarea class="form-control" id="address" rows="3" required></textarea>
        </div>
      </div>

      <!-- Billing toggle -->
      <div class="mt-4">
        <label class="form-label">Billing Address</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="billingOption" id="sameBilling" value="same" checked>
          <label class="form-check-label" for="sameBilling">Same as shipping</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="billingOption" id="differentBilling" value="different">
          <label class="form-check-label" for="differentBilling">Use different billing address</label>
        </div>
      </div>

      <!-- Billing fields -->
      <div class="billing-section mt-3" id="billingSection">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="billingName" class="form-label">Full Name</label>
            <input type="text" class="form-control billing-required" id="billingName">
          </div>
          <div class="col-md-6">
            <label for="billingPostalCode" class="form-label">Postal Code (optional)</label>
            <input type="text" class="form-control" id="billingPostalCode">
          </div>
          <div class="col-12">
            <label for="billingAddress" class="form-label">Billing Address</label>
            <textarea class="form-control billing-required" id="billingAddress" rows="3"></textarea>
          </div>
        </div>
      </div>

      <!-- Payment method -->
      <div class="mt-4">
        <label class="form-label">Payment Method</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="Cash on Delivery" required>
          <label class="form-check-label" for="cod">Cash on Delivery</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="easypaisa" value="Easypaisa" required>
          <label class="form-check-label" for="easypaisa">Easypaisa</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="Bank Transfer" required>
          <label class="form-check-label" for="bankTransfer">Bank Transfer</label>
        </div>

        <!-- Auto-filled payment instructions -->
        <div id="paymentInstructions" class="payment-instructions"></div>
      </div>

      <!-- 10% Advance section (shown only if total > 10000 and online method chosen) -->
      <div id="advanceSection" class="mt-3 d-none">
        <div class="alert alert-warning mb-2" id="advanceText">
          <!-- populated by JS -->
        </div>
        <div class="small-muted mb-2">After sending the advance, enter your transaction ID below.</div>
        <div class="row g-2">
          <div class="col-md-6">
            <label for="transactionId" class="form-label">Transaction ID</label>
            <input id="transactionId" class="form-control" placeholder="e.g., TID123456" />
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="advancePaidCheck">
              <label class="form-check-label" for="advancePaidCheck">I confirm I paid the 10% advance</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="order-summary-card mt-4">
        <h5 class="mb-3">Order Summary</h5>
        <div class="row g-2">
          <div class="col-12">
            <span>Items Total:</span>
            <span><strong id="itemsTotal">0</strong> PKR</span>
          </div>
          <div class="col-12">
            <span>Shipping:</span>
            <span><strong id="shippingCost">199</strong> PKR</span>
          </div>
          <div class="col-12">
            <span>Tax (4%):</span>
            <span><strong id="taxAmount">0</strong> PKR</span>
          </div>
          <hr/>
          <div class="col-12">
            <span class="fw-bold text-primary">Final Price:</span>
            <span class="fw-bold text-primary"><strong id="finalPrice">0</strong> PKR</span>
          </div>
        </div>
      </div>

      <button id="submitBtn" type="submit" class="btn btn-primary w-100 mt-4">
        Place Order
      </button>
    </form>
  </div>

  <script>
    // ========= Helpers =========
   const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://localhost:5000'
  : 'https://garrisonstore-production.up.railway.app';
// use same-origin in production
    const ORDERS_URL = API_BASE + '/api/orders';
    const SHIPPING_FLAT = 199;

    const el = (id) => document.getElementById(id);
    const statusArea = el('statusArea');
    const showStatus = (type, msg) => {
      statusArea.className = `alert alert-${type}`;
      statusArea.textContent = msg;
      statusArea.classList.remove('d-none');
    };
    const clearStatus = () => {
      statusArea.className = 'd-none';
      statusArea.textContent = '';
    };

    // ========= Load cart from localStorage (safe) =========
    function getCart() {
      try {
        const raw = localStorage.getItem('cart');
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function calcItemsTotal(cart) {
      // Sum price * quantity, guard against bad data
      return cart.reduce((sum, item) => {
        const price = Number(item?.price) || 0;
        const qty = Number(item?.quantity) || 1;
        return sum + price * qty;
      }, 0);
    }

    // ========= State =========
    let cartItems = getCart();
    let itemsTotalValue = calcItemsTotal(cartItems); // 0 if empty/bad
    let taxValue = 0;
    let finalPrice = 0;

    // ========= UI updates =========
    function formatPKR(n) {
      // keep it simple; you can localize if needed
      return Math.round(Number(n)).toLocaleString();
    }

    function updateSummary() {
      // guard against NaN
      if (typeof itemsTotalValue !== 'number' || isNaN(itemsTotalValue) || itemsTotalValue < 0) {
        itemsTotalValue = 0;
      }
      taxValue = +(itemsTotalValue * 0.04).toFixed(2);
      finalPrice = +(itemsTotalValue + SHIPPING_FLAT + taxValue).toFixed(2);

      el('itemsTotal').textContent = formatPKR(itemsTotalValue);
      el('shippingCost').textContent = formatPKR(SHIPPING_FLAT);
      el('taxAmount').textContent = formatPKR(taxValue);
      el('finalPrice').textContent = formatPKR(finalPrice);

      updateAdvanceSectionVisibility();
    }

    function updatePaymentInstructions(method) {
      const pi = el('paymentInstructions');
      if (method === 'Cash on Delivery') {
        pi.innerHTML = 'Pay in cash when your order is delivered.';
      } else if (method === 'Easypaisa') {
        pi.innerHTML = 'Easypaisa Account: <strong>0336-5592277</strong> (Abdul Rasheed Chaudhary).<br><span class="small-muted">Send your payment screenshot to this number.</span>';
      } else if (method === 'Bank Transfer') {
        pi.innerHTML = 'Bank Account: <strong>55240081004365011</strong> (Bank Al Habib, Abdul Rasheed Chaudhary).<br><span class="small-muted">Send your payment screenshot to this number 0336-5592277.</span>';
      } else {
        pi.textContent = '';
      }
    }

    function needsAdvance(method) {
      // Require 10% advance for large orders ONLY when online methods are chosen
      return (finalPrice > 10000) && (method === 'Easypaisa' || method === 'Bank Transfer');
    }

    function updateAdvanceSectionVisibility() {
      const methodEl = document.querySelector('input[name="paymentMethod"]:checked');
      const method = methodEl ? methodEl.value : null;
      const advanceDiv = el('advanceSection');
      const advanceText = el('advanceText');

      if (method && needsAdvance(method)) {
        const advanceAmt = +(finalPrice * 0.10).toFixed(2);
        advanceText.innerHTML = `âš  <strong>Advance Payment Required:</strong> Orders over 10,000 PKR require a 10% advance when paying via <strong>${method}</strong>.<br>
        Please pay <strong>${formatPKR(advanceAmt)}</strong> PKR and enter your transaction ID below.`;
        advanceDiv.classList.remove('d-none');
      } else {
        advanceDiv.classList.add('d-none');
        el('advancePaidCheck').checked = false;
        el('transactionId').value = '';
      }
    }

    // ========= Init summary =========
    updateSummary();

    // ========= Payment method listeners =========
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
      radio.addEventListener('change', function() {
        updatePaymentInstructions(this.value);
        updateAdvanceSectionVisibility();
      });
    });

    // ========= Billing toggle =========
    document.querySelectorAll('input[name="billingOption"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const billingSection = el('billingSection');
        const requiredFields = document.querySelectorAll('.billing-required');
        if (this.value === 'different') {
          billingSection.style.display = 'block';
          requiredFields.forEach(f => f.setAttribute('required', 'required'));
        } else {
          billingSection.style.display = 'none';
          requiredFields.forEach(f => f.removeAttribute('required'));
        }
      });
    });

    // ========= Submit handler =========
    el('checkoutForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      clearStatus();

      // Basic client-side validation
      if (typeof itemsTotalValue !== 'number' || isNaN(itemsTotalValue) || itemsTotalValue < 0) {
        showStatus('danger', 'Cart total is invalid. Please refresh the page.');
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
      if (!paymentMethod) {
        showStatus('danger', 'Please select a payment method.');
        return;
      }

  
      // Gather shipping/billing
      const payload = {
        customerName: el('customerName').value.trim(),
        email: el('email').value.trim(),
        phone: el('phone').value.trim(),
        address: el('address').value.trim(),
        postalCode: el('postalCode').value.trim(),
        paymentMethod,
        billingData: {},
        items: cartItems.map(i => ({
          product: i?.id || i?._id || null, 
          name: i?.name || '',
          price: Number(i?.price) || 0,
          image: i?.image || '',
          quantity: Number(i?.quantity) || 1
        })),
        itemsTotal: itemsTotalValue // backend will compute tax/total safely
      };

      if (document.querySelector('input[name="billingOption"]:checked')?.value === 'different') {
        payload.billingData = {
          billingName: el('billingName').value.trim(),
          billingAddress: el('billingAddress').value.trim(),
          billingPostalCode: el('billingPostalCode').value.trim()
        };
      }

      // Optional: include advance meta fields (for admin reference)
      if (needsAdvance(paymentMethod)) {
        payload.advanceMeta = {
          required: true,
          transactionId: el('transactionId').value.trim(),
          advanceRequiredAmount: +(finalPrice * 0.10).toFixed(2)
        };
      }

      // Disable button while submitting
      const btn = el('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Placing order...';

      try {
        const res = await fetch(ORDERS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json'
             
           },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          showStatus('danger', data?.message || 'Failed to place order.');
          btn.disabled = false;
          btn.textContent = 'Place Order';
          return;
        }

        // Success
        showStatus('success', 'âœ… Order placed successfully!');
        // Clear cart and redirect after a second
        localStorage.removeItem('cart');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);

      } catch (err) {
        console.error(err);
        showStatus('danger', 'Server error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Place Order';
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
